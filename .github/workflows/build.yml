name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: debugprobe
      - name: Pull Zephyr CI image
        run: docker pull ghcr.io/zephyrproject-rtos/ci:v0.28.7
      - name: Initialize Zephyr workspace and build
        run: |
          mkdir -p ${{ github.workspace }}/artifacts
          docker run --rm \
            -v ${{ github.workspace }}/debugprobe:/workdir/debugprobe \
            -v ${{ github.workspace }}/artifacts:/workdir/artifacts \
            -w /workdir \
            ghcr.io/zephyrproject-rtos/ci:v0.28.7 \
            bash -c "
              west init -l debugprobe && \
              west update && \
              west zephyr-export && \
              west build -b rpi_pico -d build_rpi_pico debugprobe && \
              west build -b rpi_pico/rp2040/w -d build_rpi_pico_w debugprobe && \
              west build -b rpi_pico2/rp2350a/m33 -d build_rpi_pico2 debugprobe && \
              west build -b rpi_pico2/rp2350a/m33/w -d build_rpi_pico2_w debugprobe && \
              west build -b native_sim -d build_native_sim debugprobe && \
              west build -b ek_ra4m2 -d build_ek_ra4m2 debugprobe && \
              cp build_rpi_pico/zephyr/zephyr.uf2 artifacts/debugprobe_rpi_pico.uf2 && \
              cp build_rpi_pico_w/zephyr/zephyr.uf2 artifacts/debugprobe_rpi_pico_w.uf2 && \
              cp build_rpi_pico2/zephyr/zephyr.uf2 artifacts/debugprobe_rpi_pico2.uf2 && \
              cp build_rpi_pico2_w/zephyr/zephyr.uf2 artifacts/debugprobe_rpi_pico2_w.uf2 && \
              cp build_ek_ra4m2/zephyr/zephyr.hex artifacts/debugprobe_ek_ra4m2.hex
            "
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: |
            ${{ github.workspace }}/artifacts/*.uf2
            ${{ github.workspace }}/artifacts/*.hex
